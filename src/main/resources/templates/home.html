<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario</title>

    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
        }

        .table-inventory thead {
            background-color: #0d6efd;
            color: white;
        }

        .table-history thead {
            background-color: #6c757d;
            color: white;
        }

        .badge-in {
            background-color: #198754;
            color: white;
        }

        .badge-out {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>

<body>
    <div id="userInfo" th:data-user-rol="${user.idRol.idRol}" th:data-user-correo="${user.correo}"></div>
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-boxes"></i> Inventario</span>

        </div>
    </nav>

    <div class="container">

        <!-- Modal -->
        <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="transactionModalLabel">Agregar Movimiento</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="transactionFormmodal" class="row g-3">

                            <div class="col-md-6">
                                <label class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="cantidadModal" min="1" value="1" required>
                                <input style="display:none;" id="productID" value="">
                            </div>

                            <div class="col-md-6 d-flex align-items-end gap-2">
                                <button onclick="aumentarProducto()" type="button" class="btn btn-success w-50"
                                    th:if="${user.idRol.idRol == 1}">
                                    <i class="fas fa-plus-circle"></i> Entrada
                                </button>
                                <button onclick="disminuirProducto()" type="button" class="btn btn-danger w-50"
                                    th:if="${user.idRol.idRol == 2}">
                                    <i class="fas fa-minus-circle"></i> Salida
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button id="modalcerrar" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Input Section -->
        <div class="card" th:if="${user.idRol.idRol == 1}">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> Agregar </h5>
            </div>
            <div class="card-body">
                <form id="transactionForm" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Nombre Producto</label>
                        <input type="text" class="form-control" id="nombre" placeholder="e.g. Laptop, Mouse" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="cantidad" min="0" max="0" value="0" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">precio U</label>
                        <input type="number" class="form-control" id="precio" min="0" value="0" required>
                        <input type="number" style="display:none;" id="estatus" value="1">
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button type="button" class="btn btn-success w-50" onclick="handleTransaction('IN')">
                            <i class="fas fa-plus-circle"></i> Agregar
                        </button>
                        <button type="button" class="btn btn-danger w-50" onclick="handleTransaction('OUT')">
                            <i class="fas fa-minus-circle"></i> Eliminar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row">
            <!-- Current Inventory Section -->
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Inventario Actual</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-inventory mb-0 text-center">
                                <thead>
                                    <tr>
                                        <th>Estatus</th>
                                        <th>Nombre Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio</th>
                                        <th>Accion</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryBody">

                                </tbody>
                            </table>
                        </div>
                        <div id="emptyHistory" class="text-center p-3 text-muted" style="display:none;">
                            No hay datos.
                        </div>
                    </div>
                </div>
            </div>

            <!-- History / Logs Section -->
            <div class="col-lg-5" th:if="${user.idRol.idRol == 1}">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Historico</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-history mb-0 text-center font-monospace small">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Tipo</th>
                                        <th>Usuario</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody">
                                    <!-- History logs will appear here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="emptyHistory" class="text-center p-3 text-muted" style="display:none;">
                            No hay datos.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        var userInfoDiv = document.getElementById('userInfo');
        var rolJAVA = userInfoDiv.getAttribute('data-user-rol');
        var correoJAVA = userInfoDiv.getAttribute('data-user-correo');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            if(rolJAVA == 1){
              loadHistorico();
            }

        });


        // ModalID
        const Modal = document.getElementById('transactionModal');
        if (Modal) {
            Modal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const productid = button.dataset.productid;
                const modalBodyIdInput = Modal.querySelector('#productID');
                modalBodyIdInput.value = productid;
            });
        }
        // --- Core Logic ---
        const API_URL_PRODUCTOS = '/api/productos';
        const API_URL_HISTORICO = '/api/historico';


        function loadProducts() {

            fetch(API_URL_PRODUCTOS) // Usar la API Fetch de JavaScript
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('inventoryBody');
                    data.forEach(producto => { // Iterar sobre los datos JSON
                        const row = document.createElement('tr');

                        row.innerHTML = `<td id="productID" style="display:none;">${producto.id}</td><td>${producto.estatus == 1 ? '<i class="fas fa-check-circle text-success" title="Activo"></i>' : '<i class="fas fa-times-circle text-danger" title="Inactivo"></i>'}</td><td>${producto.nombreProducto}</td><td>${producto.cantidad}</td><td>${producto.precio}</td><td><button data-bs-toggle="modal" data-productid="${producto.id}"" data-bs-target="#transactionModal"><i class="fas fa-plus-circle"></i></button></td>`;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error al cargar:', error));
        }

        function loadHistorico() {

            fetch(API_URL_HISTORICO) // Usar la API Fetch de JavaScript
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('historyBody');
                    data.forEach(producto => { // Iterar sobre los datos JSON
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${producto.createdAt}</td><td>${producto.tipoMovimiento == 1 ? "entrada" : producto.tipoMovimiento == 3 ? "baja" : "salida"}</td><td>${producto.usuarioMovimiento}</td>`;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error al cargar:', error));
        }



        async function historicomovimiento(historico) {
            await fetch(API_URL_HISTORICO, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(historico),
            })
                .then(data => {
                    console.log('Success:', data);
                    return data.json()
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        async function movimiento(producto) {
            await fetch(API_URL_PRODUCTOS+"/"+producto.id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(producto),
            })
                .then(data => {
                    console.log('Success:', data);
                    return data.json()
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

  
        function disminuirProducto() {
            const productID = document.getElementById('productID');
            const cantidadModal = document.getElementById('cantidadModal');

            fetch(API_URL_PRODUCTOS + "/" + productID.value)
                .then(data => {
                    return data.json();
                }).then(producto => {
                    producto.cantidad =  Number(producto.cantidad) - Number(cantidadModal.value)
                    if(producto.cantidad > 0 ){
                    movimiento(producto).then(() => { 
                        historicomovimiento({ "usuarioMovimiento": correoJAVA, "tipoMovimiento": 2, "cantidad": producto.cantidad, "idProducto": producto.id }).then(() => { reloadTables() });
                    })
                }else{alert("no se tienen existencias")}
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
                document.getElementById('modalcerrar').click();
        }

        function aumentarProducto() {
            const productID = document.getElementById('productID');
            const cantidadModal = document.getElementById('cantidadModal');

            fetch(API_URL_PRODUCTOS + "/" + productID.value)
                .then(data => {
                    return data.json();
                }).then(producto => {
                    producto.cantidad = Number(cantidadModal.value) + Number(producto.cantidad)
                    movimiento(producto).then(() => { 
                        historicomovimiento({ "usuarioMovimiento": correoJAVA, "tipoMovimiento": 1, "cantidad": producto.cantidad, "idProducto": producto.id }).then(() => { reloadTables() });
                    })
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
                document.getElementById('modalcerrar').click();
        }

        function handleTransaction(type) {

            const nameInput = document.getElementById('nombre');
            const priceInput = document.getElementById('precio');
            const statusInput = document.getElementById('estatus');
            const qtyInput = document.getElementById('cantidad');


            const name = nameInput.value.trim().toUpperCase();
            const qty = parseInt(qtyInput.value);
            const price = parseInt(priceInput.value);
            const status = parseInt(statusInput.value);


            if (!name) {
                alert("nombre invalido ");
                return;
            }


            // Logic for Stock IN
            if (type === 'IN') {

        
                if (!price || price <= -1) {
                    alert("precio invalido");
                    return;
                }

                const producto = {
                    nombreProducto: name,
                    precio: price,
                    cantidad: qty,
                    estatus: status
                };

                fetch(API_URL_PRODUCTOS, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(producto),
                }).then(data => {
                    console.log('Success:', data);
                    return data.json();
                }).then(producto => {
                    historicomovimiento({ "usuarioMovimiento": correoJAVA, "tipoMovimiento": 1, "cantidad": producto.cantidad, "idProducto": producto.id }).then(() => { reloadTables() })
                })
                    .catch((error) => {
                        console.error('Error:', error);
                    })
                //  addToHistory('IN', name, qty);
            }
            // Logic for Stock OUT
            else if (type === 'OUT') {

                fetch(API_URL_PRODUCTOS + "/" + name, {
                    method: 'DELETE'
                }).then(data => {
                    console.log('Success:', data);
                    return data.json();
                }).then(producto => {
                    historicomovimiento({ "usuarioMovimiento": correoJAVA, "tipoMovimiento": 3, "cantidad": producto.cantidad, "idProducto": producto.id }).then(() => { reloadTables() })
                })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }
        }

        function reloadTables() {
            const tbodyinv = document.getElementById('inventoryBody');
            tbodyinv.innerHTML = '';

            loadProducts();
            if(rolJAVA == 1){
            const tbodyhis = document.getElementById('historyBody');
            tbodyhis.innerHTML = '';
              loadHistorico();
            }
     
        }


    </script>
</body>


</html>
